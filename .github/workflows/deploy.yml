name: ðŸš€ RULETTT Auto Deploy

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test:
    name: ðŸ§ª Ð¢ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout ÐºÐ¾Ð´Ð°
      uses: actions/checkout@v4
      
    - name: ðŸ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÐºÐ¾Ð´Ð° Python
      run: |
        python -m py_compile console_to_analysis.py
        python -m py_compile auto_console_collector.py
        
    - name: ðŸ§ª Ð¢ÐµÑÑ‚ ÐºÐ¾Ð»Ð»ÐµÐºÑ‚Ð¾Ñ€Ð°
      run: |
        python -c "
        import json
        # Ð¢ÐµÑÑ‚ Ð¾ÑÐ½Ð¾Ð²Ð½Ñ‹Ñ… Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¹
        print('âœ… Ð¢ÐµÑÑ‚ ÐºÐ¾Ð»Ð»ÐµÐºÑ‚Ð¾Ñ€Ð° Ð¿Ñ€Ð¾ÑˆÐµÐ» ÑƒÑÐ¿ÐµÑˆÐ½Ð¾')
        "
        
    - name: ðŸ“Š Ð¢ÐµÑÑ‚ Ð°Ð½Ð°Ð»Ð¸Ð·Ð°Ñ‚Ð¾Ñ€Ð°  
      run: |
        python -c "
        # Ð¢ÐµÑÑ‚ Ð°Ð½Ð°Ð»Ð¸Ð·Ð°Ñ‚Ð¾Ñ€Ð° Ñ Ñ„Ð¸ÐºÑ‚Ð¸Ð²Ð½Ñ‹Ð¼Ð¸ Ð´Ð°Ð½Ð½Ñ‹Ð¼Ð¸
        test_data = [1, 2, 3, 4, 5] * 20
        print(f'âœ… Ð¢ÐµÑÑ‚ Ð°Ð½Ð°Ð»Ð¸Ð·Ð°Ñ‚Ð¾Ñ€Ð°: {len(test_data)} Ð·Ð°Ð¿Ð¸ÑÐµÐ¹')
        "

  deploy-github-pages:
    name: ðŸŒ Deploy to GitHub Pages
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    permissions:
      contents: read
      pages: write
      id-token: write
      
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - name: ðŸ“¥ Checkout
      uses: actions/checkout@v4
      
    - name: ðŸ› ï¸ ÐŸÐ¾Ð´Ð³Ð¾Ñ‚Ð¾Ð²ÐºÐ° Ðº Ð´ÐµÐ¿Ð»Ð¾ÑŽ
      run: |
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¿Ð°Ð¿ÐºÑƒ Ð´Ð»Ñ GitHub Pages
        mkdir -p gh-pages
        
        # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ð²ÐµÐ±-Ð¸Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹Ñ
        cp -r webapp/* gh-pages/
        
        # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ð¾ÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹
        cp auto_collector_console_code.js gh-pages/
        cp console_to_analysis.py gh-pages/
        cp README.md gh-pages/
        
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ index.html ÐºÐ°Ðº Ð³Ð»Ð°Ð²Ð½ÑƒÑŽ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñƒ
        cp webapp/dashboard.html gh-pages/index.html
        
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ñ„Ð°Ð¹Ð» ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸
        echo "ðŸŽ² RULETTT - Ð“Ð¾Ñ‚Ð¾Ð² Ðº Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸ÑŽ!" > gh-pages/status.txt
        
    - name: ðŸ“¦ Setup Pages
      uses: actions/configure-pages@v3
      
    - name: ðŸ“¤ Upload artifact
      uses: actions/upload-pages-artifact@v2
      with:
        path: './gh-pages'
        
    - name: ðŸš€ Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v2

  deploy-netlify:
    name: ðŸ”µ Deploy to Netlify
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: ðŸ“¥ Checkout
      uses: actions/checkout@v4
      
    - name: ðŸ› ï¸ ÐŸÐ¾Ð´Ð³Ð¾Ñ‚Ð¾Ð²ÐºÐ° Netlify
      run: |
        mkdir -p netlify-dist
        cp -r webapp/* netlify-dist/
        cp auto_collector_console_code.js netlify-dist/
        cp README.md netlify-dist/
        
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ _redirects Ð´Ð»Ñ SPA
        echo "/* /dashboard.html 200" > netlify-dist/_redirects
        
    - name: ðŸš€ Deploy to Netlify
      uses: nwtgck/actions-netlify@v2.1
      with:
        publish-dir: './netlify-dist'
        production-branch: main
        github-token: ${{ secrets.GITHUB_TOKEN }}
        deploy-message: "ðŸŽ² RULETTT Auto Deploy - ${{ github.sha }}"
        enable-pull-request-comment: true
        enable-commit-comment: true
      env:
        NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
        NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}

  deploy-vercel:
    name: â–² Deploy to Vercel
    needs: test  
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: ðŸ“¥ Checkout
      uses: actions/checkout@v4
      
    - name: ðŸ› ï¸ ÐŸÐ¾Ð´Ð³Ð¾Ñ‚Ð¾Ð²ÐºÐ° Vercel
      run: |
        mkdir -p vercel-dist
        cp -r webapp/* vercel-dist/
        cp auto_collector_console_code.js vercel-dist/
        
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ vercel.json
        cat > vercel-dist/vercel.json << 'EOF'
        {
          "version": 2,
          "name": "rulettt-pro",
          "builds": [
            {
              "src": "**/*",
              "use": "@vercel/static"
            }
          ],
          "routes": [
            {
              "src": "/(.*)",
              "dest": "/dashboard.html"
            }
          ]
        }
        EOF
        
    - name: ðŸš€ Deploy to Vercel
      uses: amondnet/vercel-action@v25
      with:
        vercel-token: ${{ secrets.VERCEL_TOKEN }}
        vercel-org-id: ${{ secrets.ORG_ID }}
        vercel-project-id: ${{ secrets.PROJECT_ID }}
        working-directory: ./vercel-dist
        vercel-args: '--prod'

  notify:
    name: ðŸ“¢ Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ
    needs: [deploy-github-pages, deploy-netlify, deploy-vercel]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: ðŸ“Š Ð¡Ñ‚Ð°Ñ‚ÑƒÑ Ð´ÐµÐ¿Ð»Ð¾Ñ
      run: |
        echo "ðŸŽ² RULETTT Deploy Status:"
        echo "âœ… GitHub Pages: ${{ needs.deploy-github-pages.result }}"
        echo "ðŸ”µ Netlify: ${{ needs.deploy-netlify.result }}"  
        echo "â–² Vercel: ${{ needs.deploy-vercel.result }}"
        
        if [[ "${{ needs.deploy-github-pages.result }}" == "success" ]] || 
           [[ "${{ needs.deploy-netlify.result }}" == "success" ]] || 
           [[ "${{ needs.deploy-vercel.result }}" == "success" ]]; then
          echo "ðŸš€ Ð¥Ð¾Ñ‚Ñ Ð±Ñ‹ Ð¾Ð´Ð¸Ð½ Ð´ÐµÐ¿Ð»Ð¾Ð¹ ÑƒÑÐ¿ÐµÑˆÐµÐ½!"
          exit 0
        else
          echo "âŒ Ð’ÑÐµ Ð´ÐµÐ¿Ð»Ð¾Ð¸ Ð¿Ñ€Ð¾Ð²Ð°Ð»Ð¸Ð»Ð¸ÑÑŒ"
          exit 1
        fi